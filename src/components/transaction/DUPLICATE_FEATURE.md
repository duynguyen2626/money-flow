# Duplicate Transaction Feature - Rewritten (Feb 2, 2026)

## Overview
Duplicate transaction feature has been completely rewritten from scratch, now integrated with TransactionSlideV2 (V2 system).

## Architecture

### Components Involved
1. **UnifiedTransactionsPage** - Manages state: `slideMode`, `selectedTxn`
2. **UnifiedTransactionTable** - Renders duplicate button in action column
3. **TransactionSlideV2** - Handles form UI and submission

### Data Flow
```
User clicks duplicate button in action column
    ↓
UnifiedTransactionTable.onDuplicate callback
    ↓
handleDuplicate() in UnifiedTransactionsPage
    ↓
Sets: slideMode='duplicate', selectedTxn={txn}
    ↓
initialSlideData computed with duplicate-specific values
    ↓
TransactionSlideV2 opens with title "Duplicate Transaction"
    ↓
User edits and saves
    ↓
New transaction created with same details
```

## Implementation Details

### 1. Button in Action Column
**File:** [unified-transaction-table.tsx](src/components/moneyflow/unified-transaction-table.tsx) lines 1276-1282

```tsx
<CustomTooltip content="Duplicate">
  <button
    className="p-1.5 text-slate-400 hover:text-purple-600 hover:bg-purple-50 rounded-md transition-colors"
    onClick={(e) => { e.stopPropagation(); externalOnDuplicate?.(txn); }}
  >
    <Files className="h-3.5 w-3.5" />
  </button>
</CustomTooltip>
```

**Icon:** `Files` (two stacked documents) - distinct from Copy icon in notes column
**Position:** Right of Edit (Pencil) button
**Color:** Purple hover state (different from blue Edit)

### 2. State Management
**File:** [UnifiedTransactionsPage.tsx](src/components/transactions/UnifiedTransactionsPage.tsx)

```tsx
const [slideMode, setSlideMode] = useState<'add' | 'edit' | 'duplicate'>('add')
const [selectedTxn, setSelectedTxn] = useState<TransactionWithDetails | null>(null)

const handleDuplicate = (t: TransactionWithDetails) => {
    setSlideOverrideType(undefined)
    setSlideMode('duplicate')
    setSelectedTxn(t)
    setIsSlideOpen(true)
}
```

### 3. Initial Data Calculation
**File:** [UnifiedTransactionsPage.tsx](src/components/transactions/UnifiedTransactionsPage.tsx) lines 548-550

When `slideMode === 'duplicate'`:
- All transaction details copied from source
- **Exception:** `occurred_at` set to **new Date()** (today's date)
- This allows duplicating old transactions with new date

### 4. Slide Header Title
**File:** [transaction-slide-v2.tsx](src/components/transaction/slide-v2/transaction-slide-v2.tsx) lines 300-305

```tsx
{mode === 'single'
    ? (operationMode === 'duplicate' 
        ? 'Duplicate Transaction'
        : operationMode === 'edit' 
        ? 'Edit Transaction'
        : 'New Transaction')
    : 'Bulk Add'
}
```

New prop `operationMode?: 'add' | 'edit' | 'duplicate'` passed from page

## Key Features

### ✅ Clean Code
- Based on proven `handleEdit` pattern
- No hacky state management
- Proper TypeScript types

### ✅ No Closing Issues
- Uses same back button logic as edit mode
- Force closes without warning (UX feature)
- Proper cleanup of state

### ✅ User-Friendly
- Clear "Duplicate Transaction" title (not "Edit")
- Distinct icon (Files, not Copy)
- New date on duplicated transaction
- Purple hover state differentiates from Edit

### ✅ Safe Submission
- Creates new transaction (doesn't modify original)
- New ID generated by API
- No data loss risk

## Files Modified

| File | Changes |
|------|---------|
| [unified-transaction-table.tsx](src/components/moneyflow/unified-transaction-table.tsx) | Added duplicate button, import Files icon, onDuplicate prop |
| [UnifiedTransactionsPage.tsx](src/components/transactions/UnifiedTransactionsPage.tsx) | Pass operationMode to TransactionSlideV2, onDuplicate to table |
| [transaction-slide-v2.tsx](src/components/transaction/slide-v2/transaction-slide-v2.tsx) | Accept operationMode, render title based on mode |
| [types.ts](src/components/transaction/slide-v2/types.ts) | Add operationMode prop type |

## Testing Checklist

- [x] Button appears in action column next to Edit
- [x] Tooltip shows "Duplicate"
- [x] Click opens slide panel
- [x] Slide title is "Duplicate Transaction"
- [x] Form pre-filled with transaction data
- [x] Date is set to today (not original date)
- [x] Back button closes slide immediately
- [x] Submit creates new transaction
- [x] No console errors
- [x] Build passes: 22.5s

## Future Improvements

1. **Batch Duplicate:** Add option to duplicate multiple transactions
2. **Quick Duplicate:** Option to duplicate without opening form
3. **Template Duplicate:** Save transaction as template, duplicate as many times
4. **Recurring:** Auto-duplicate on schedule

## Related Code

- **Edit Feature:** Same pattern, reference if modifying
- **Back Button:** Force closes, no warning blocker
- **Initial Data:** Reused from edit, just with `occurred_at` override

---
**Status:** ✅ Complete and tested  
**Build:** ✅ Compiled successfully in 22.5s  
**Ready for:** Production use
